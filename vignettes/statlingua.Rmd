---
title: "statlingua"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{statlingua}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

**WARNING:** This vignette is incomplete and still very much a work in progress!

**TODO:**

1. Provide more context for each chosen example.
2. Explain why we're using `cat()` to format the output here.

## Explaining the output from statistical models

The following example is taken from a [tutorial on paired t-tests](https://www.jmp.com/en/statistics-knowledge-portal/t-test/paired-t-test). Here we use an independent two-sample t-test to (inappropriately) analyze paired data.

```{r ex-t-test}
context <- "
An instructor wants to use two exams in her classes next year. This year, she gives both exams to the students. She wants to know if the exams are equally difficult and wants to check this by comparing the two sets of scores. Here is the data:

 student exam_1_score exam_2_score
     Bob           63           69
    Nina           65           65
     Tim           56           62
    Kate          100           91
  Alonzo           88           78
    Jose           83           87
  Nikhil           77           79
   Julia           92           88
   Tohru           90           85
 Michael           84           92
    Jean           68           69
   Indra           74           81
   Susan           87           84
   Allen           64           75
    Paul           71           84
  Edwina           88           82
"

# Create the data set
exam_scores <- tibble::tribble(
  ~student,  ~exam_1_score, ~exam_2_score,
  "Bob",     63,            69,
  "Nina",    65,            65,
  "Tim",     56,            62,
  "Kate",    100,           91,
  "Alonzo",  88,            78,
  "Jose",    83,            87,
  "Nikhil",  77,            79,
  "Julia",   92,            88,
  "Tohru",   90,            85,
  "Michael", 84,            92,
  "Jean",    68,            69,
  "Indra",   74,            81,
  "Susan",   87,            84,
  "Allen",   64,            75,
  "Paul",    71,            84,
  "Edwina",  88,            82
)

# Run a two-sample t-test
(tt <- t.test(exam_scores$exam_1_score, y = exam_scores$exam_2_score))
```

Next, we initialize a client to chat with a Google Gemini model and call the `explain()` method to explain the output from the statistical test. Calling `explain()` essentially provides the client with an appropriate system prompt and user query to generate an explanation about the provided statistical output. (Note that we can establish a client to chat with any model supported by the [ellmer](https://cran.r-project.org/package=ellmer) package.) 

```{r ex-t-test-explain, cache=TRUE, results="asis"}
library(statlingua)

client <- ellmer::chat_google_gemini(echo = "none")
(ex <- explain(tt, client = client, context = context))
```

Note that the `explain()` function in **statlingua** is designed to return a single character string. This string is often formatted by the Large Language Model using Markdown, which includes special characters to structure the text, most notably:

* Newline characters (`\n`) which are used to create line breaks, separate paragraphs, define list items, and structure headings in Markdown.
* Other white space (like spaces for indentation) used for formatting lists or code blocks.

Hence, it's more useful to pass the output of `explain()` into R's built-in `cat()` function for readability in an R console. This is also useful for displaying the output properly in Markdown (like we do in this vignette)!

```{r ex-t-test-explain-cat, cache=TRUE, results="asis"}
cat(ex)  # for readability (this produces the Markdown that follows)
```

We can also print the `client` object itself, which will display the following components:

1) The system prompt (defining how the LLM should respond).
2) The user query (constructed internally by `explain()`).
3) The LLM's response.

```{r ex-t-test-explanation-client}
print(client)
```


## Example: polynomial regression

The following example fits a quadratic linear model to the built-in `cars` data set.

```{r ex-lm-polynomial}
# Polynomial regression
cars_lm <- lm(dist ~ poly(speed, degree = 2), data = cars)
summary(cars_lm)
```

```{r ex-lm-polynomial-explain, cache=TRUE, results="asis"}
context <- "
The data give the speed of cars (mph) and the distances taken to stop (ft).
Note that the data were recorded in the 1920s.
"
client <- ellmer::chat_google_gemini(echo = "none")
ex <- explain(cars_lm, client = client, context = context)
cat(ex)
```

Oftentimes you may have additional follow up questions about the output or explanation. In this case, it is useful to query the LLM again using the original `client` object:

```{r ex-lm-polynomial-explain-query, cache=TRUE, results="asis"}
client$chat("Elaborate further on the meaning of R-squared in this example.") |> cat()
```

## Example: Poisson regression

The following example uses the generic function `explain()` to explain the output from a fitted [Poisson GLM](https://en.wikipedia.org/wiki/Poisson_regression) using simple Markdown syntax:

```{r ex-glm-poisson}
# Poisson regression example from ?stats::glm
counts <- c(18,17,15,20,10,20,25,13,12)
outcome <- gl(3,1,9)
treatment <- gl(3,3)
summary(D93_glm <- glm(counts ~ outcome + treatment, family = poisson()))
```

```{r ex-glm-poisson-explain, cache=TRUE, results="asis"}
chat <- ellmer::chat_google_gemini(echo = "none")
ex <- explain(D93_glm, client = client) 
cat(ex)
```
